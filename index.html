<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mortgage Calculator</title>
  <link rel="stylesheet" href="cfa-base.css">
  <link rel="stylesheet" href="mortgage-specific.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        skipTags: ["script","noscript","style","textarea","pre","code"]
      },
      TeX: {
        extensions: ["color.js"]
      },
      "HTML-CSS": {
        availableFonts: ["TeX"],
        scale: 100,
        linebreaks: { automatic: true }
      },
      SVG: {
        font: "TeX",
        linebreaks: { automatic: true }
      },
      showProcessingMessages: false,
      messageStyle: "none"
    });
    
    // Fix ARIA issues after MathJax renders - use RegisterStartupHook to ensure it runs after rendering
    MathJax.Hub.Register.StartupHook("End", function() {
      setTimeout(function() {
        // Remove tabindex from ALL MathJax elements
        document.querySelectorAll('.MathJax, .MathJax_Display, .MathJax_SVG, span[id^="MathJax-Element"]').forEach(el => {
          el.removeAttribute('tabindex');
          el.setAttribute('aria-hidden', 'true');
        });
        
        // Also remove from any nested spans inside MathJax
        document.querySelectorAll('.MathJax span[tabindex], .MathJax_Display span[tabindex], .MathJax_SVG span[tabindex]').forEach(el => {
          el.removeAttribute('tabindex');
        });
      }, 100);
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_SVG"></script>
</head>
<body>

  <!-- SKIP LINKS -->
  <nav aria-label="Skip links">
    <a href="#principal" class="skip-link">Skip to data entry</a>
    <a href="#data-table" class="skip-link">Skip to data table</a>
  </nav>

  <!-- NOSCRIPT FALLBACK -->
  <noscript>
    <div style="padding: 2rem; text-align: center; background: #fef2f2; border: 2px solid #b91c1c; border-radius: 0.5rem; margin: 2rem auto; max-width: 600px;">
      <h5 style="color: #991b1c; margin-bottom: 1rem; font-size: 1.125rem;">JavaScript Required</h5>
      <p style="color: #374151; line-height: 1.6; margin-bottom: 0.75rem;">
        This mortgage calculator is an interactive tool that requires JavaScript to function.
      </p>
      <p style="color: #374151; line-height: 1.6; font-size: 0.875rem;">
        Please enable JavaScript in your browser settings to:
      </p>
      <ul style="text-align: left; margin: 1rem auto; max-width: 20rem; color: #374151; font-size: 0.875rem; line-height: 1.6;">
        <li>Calculate monthly mortgage payments</li>
        <li>View interactive amortization charts</li>
        <li>Explore monthly payment breakdowns</li>
        <li>See dynamic cash flow equations</li>
        <li>Adjust loan parameters in real-time</li>
      </ul>
    </div>
  </noscript>

  <div class="container">
    <main class="content">

      <!-- CARD 1 - Static Equations -->
      <section class="card" id="static-equations-card">
        <div class="static-equations-grid">
          <!-- Monthly Cash Flow Equation -->
          <div class="static-equation-row" role="group" aria-label="Monthly Cash Flow Equation">
            <p class="static-equation-label">Monthly Cash Flow Equation:</p>
            <div class="static-equation-math">
              $\textcolor{#3c6ae5}{\text{PMT}} = \dfrac{\dfrac{\textcolor{#7a46ff}{r}}{12} \times \textcolor{#b95b1d}{\text{PV}}}{1 - \left(1 + \dfrac{\textcolor{#7a46ff}{r}}{12}\right)^{-\textcolor{#0079a6}{T}}}$
            </div>
          </div>

          <!-- Interest Cash Flow Equation for t = 1 -->
          <div class="static-equation-row" role="group" aria-label="Interest Cash Flow Equation for t equals 1, first payment">
            <p class="static-equation-label">Interest Cash Flow Equation for t = 1, first payment:</p>
            <div class="static-equation-math">
              $\textcolor{#0079a6}{\text{INT}_1} = \dfrac{\textcolor{#b95b1d}{\text{PV}} \times \textcolor{#7a46ff}{r}}{12}$
            </div>
          </div>

          <!-- General Interest Cash Flow where t >= 2 -->
          <div class="static-equation-row" role="group" aria-label="General Interest Cash Flow Equation where t is greater than or equal to 2">
            <p class="static-equation-label">General Interest Cash Flow Equation where t &ge; 2:</p>
            <div class="static-equation-math">
              $\textcolor{#0079a6}{\text{INT}_t} = \dfrac{\left(\textcolor{#b95b1d}{\text{PV}} - \sum\limits_{i=1}^{\textcolor{#0079a6}{t}-1} \textcolor{#b82937}{\text{PRN}_i}\right) \times \textcolor{#7a46ff}{r}}{12}$
            </div>
          </div>

          <!-- Principal Amortization Equation -->
          <div class="static-equation-row" role="group" aria-label="Principal Amortization Equation">
            <p class="static-equation-label">Principal Amortization Equation:</p>
            <div class="static-equation-math">
              $\textcolor{#b82937}{\text{PRN}_t} = \textcolor{#3c6ae5}{\text{PMT}} - \textcolor{#0079a6}{\text{INT}_t}$
            </div>
          </div>
        </div>
      </section>

      <!-- CARD 2 - Dynamic Equation -->
      <section class="card" id="equation-card">
        <h4 class="card-title">Dynamic Cash Flow Equations</h4>
        <p class="equation-intro">These dynamic equations display the monthly payment and how it splits between interest and principal based on your inputs.</p>

        <div class="model-equations-grid" role="region" aria-label="Mortgage payment formulas">
          <!-- Monthly Payment (PMT) -->
          <article class="formula-box pmt" tabindex="0" role="region"
                   aria-label="Monthly payment formula. PMT equals r times PV divided by 1 minus the quantity 1 plus r to the power of negative t. Current result shown below equation.">
            <div class="formula-box-title">Monthly payment (<strong style="color: #3c6ae5;">$\text{PMT}$</strong>)</div>
            <div class="equation-container">
              <div id="pmt-equation">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </article>

          <!-- Interest Payment (INT_t) -->
          <article class="formula-box int" tabindex="0" role="region"
                   aria-label="Interest payment formula for month t. INT equals PV times r divided by 12. Current result for month 1 shown below equation.">
            <div class="formula-box-title">Interest payment (<strong style="color: #0079a6;">$\text{INT}_t$</strong>)</div>
            <div class="equation-container">
              <div id="int-equation">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </article>

          <!-- Principal Payment (PRN_t) -->
          <article class="formula-box prn" tabindex="0" role="region"
                   aria-label="Principal payment formula for month t. PRN equals PMT minus INT. Current result for month 1 shown below equation.">
            <div class="formula-box-title">Principal payment (<strong style="color: #b82937;">$\text{PRN}_t$</strong>)</div>
            <div class="equation-container">
              <div id="prn-equation">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- CARD 3 - Data Entry -->
      <section class="card" id="data-entry" tabindex="-1" role="region" aria-labelledby="inputs-title">
        <h4 class="card-title" id="inputs-title">Mortgage Cash Flow Calculator</h4>
        <p style="font-size: 0.875rem; color: var(--color-gray-600); margin-bottom: 1rem;">
          Enter your mortgage details below. The calculations and visualizations will update automatically as you change the values.
        </p>

        <div class="input-group-inline">
          <div class="input-inline">
            <label for="principal" class="input-label-inline">
              Mortgage amount (<strong style="color:#b95b1d;">PV</strong>):
            </label>
            <div class="input-with-suffix-inline">
              <span class="input-prefix-inline">USD</span>
              <input type="text" id="principal" class="input-field-inline input-with-prefix"
                     inputmode="decimal"
                     value="800,000"
                     aria-required="true">
            </div>
          </div>

          <div class="input-inline">
            <label for="rate" class="input-label-inline">
              Annual interest rate (<strong style="color:#7a46ff;"><em>r</em></strong>):
            </label>
            <div class="input-with-suffix-inline">
              <input type="number" id="rate" class="input-field-inline"
                     min="0.1" max="20" step="0.1" value="6"
                     aria-required="true">
              <span class="input-suffix-inline">%</span>
            </div>
          </div>

          <div class="input-inline">
            <label for="years" class="input-label-inline">
              Mortgage term:
            </label>
            <div class="input-with-suffix-inline">
              <input type="number" id="years" class="input-field-inline"
                     min="1" max="40" step="1" value="30"
                     aria-required="true">
              <span class="input-suffix-inline">yrs</span>
            </div>
          </div>
        </div>

        <div id="validation-summary" class="validation-summary" role="alert" aria-live="polite"
             style="display:none;">
          <div class="validation-title">Please correct the following:</div>
          <ul id="validation-list"></ul>
        </div>
      </section>

      <!-- CARD 4 - Visualization -->
      <section class="card" id="visualization-card" tabindex="-1" aria-labelledby="visualization-title">
        <div class="card-header-with-controls">
          <h4 class="card-title" id="visualization-title">Mortgage Cash Flows</h4>
          <div class="view-controls">
            <button id="view-chart-btn" class="toggle-btn active" aria-pressed="true" title="Switch to chart view">Chart</button>
            <button id="view-table-btn" class="toggle-btn" aria-pressed="false" title="Switch to table view">Table</button>
          </div>
        </div>
        <p class="sr-only" id="chart-keyboard-help">Chart keyboard navigation: Arrow keys move between months, Page Up/Down jump by year, T key focuses table, Home/End go to first/last month</p>

        <div id="chart-container" class="chart-wrapper">
          <canvas id="chart" role="img" aria-label="Stacked bar chart showing principal and interest payments" aria-describedby="chart-keyboard-help"></canvas>
          <div id="chart-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
        </div>

        <div id="table-container">
          <div id="table-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
          <p class="table-description" style="font-size: 0.875rem; color: var(--color-gray-700); margin-bottom: 1rem;">
            <strong>Keyboard shortcuts (when focused on expand buttons):</strong> Home/End to jump to first/last year, Page Up/Down to jump 5 years, Arrow keys to navigate between years.
          </p>
          <table id="data-table" tabindex="-1" aria-label="Amortization schedule data table">
            <caption class="sr-only">Annual amortization schedule showing year, principal, interest, and remaining balance. Years with expandable buttons can be activated to reveal monthly details.</caption>
            <thead>
              <tr>
                <th scope="col">Year</th>
                <th scope="col">Principal amortization (<strong style="color: #b82937;">PRN</strong>)</th>
                <th scope="col">Interest cash flows (<strong style="color: #0079a6;">INT</strong>)</th>
                <th scope="col">Total mortgage cash flows (<strong style="color: #3c6ae5;">PMT</strong>)</th>
                <th scope="col">Remaining balance</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- CARD 5 - Interest Data -->
      <section class="card" id="results-card" tabindex="-1" aria-labelledby="results-title">
        <h4 class="card-title" id="results-title">Interest Data</h4>
        <div id="results-content" aria-live="polite"></div>
        <div id="result-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
      </section>

    </main>
  </div>

  <script type="module" src="./calculator.js"></script>

</body>
</html>